<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tommy HQ ‚Äî Mission Control</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#0a0a0f;--bg2:#12121a;--bg3:#1a1a2e;--bg4:#22223a;
  --coral:#ff6b6b;--cyan:#00d4aa;--purple:#7c6bff;--amber:#ffb86b;
  --text:#e8e8f0;--text2:#8888a0;--text3:#55556a;
  --radius:12px;--radius-sm:8px;
}
html,body{height:100%;font-family:'Inter',system-ui,sans-serif;background:var(--bg);color:var(--text);overflow-x:hidden}
::-webkit-scrollbar{width:6px;height:6px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--bg4);border-radius:3px}
a{color:var(--cyan);text-decoration:none}

@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
@keyframes glow-coral{0%,100%{box-shadow:0 0 8px #ff6b6b44}50%{box-shadow:0 0 20px #ff6b6b66}}

/* NAV */
.nav{display:flex;align-items:center;justify-content:space-between;padding:16px 24px;border-bottom:1px solid var(--bg4);background:var(--bg2);position:sticky;top:0;z-index:100;flex-wrap:wrap;gap:12px}
.nav-left{display:flex;align-items:center;gap:10px}
.nav-left h1{font-size:20px;font-weight:800;letter-spacing:-0.5px;background:linear-gradient(135deg,var(--coral),var(--cyan));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.nav-dot{width:8px;height:8px;border-radius:50%;background:var(--cyan);box-shadow:0 0 10px var(--cyan);animation:pulse 2s infinite}
.nav-tabs{display:flex;gap:4px;flex-wrap:wrap}
.nav-tab{padding:8px 16px;border-radius:var(--radius-sm);font-size:13px;font-weight:600;cursor:pointer;color:var(--text2);background:transparent;border:none;font-family:inherit;transition:all .2s;position:relative}
.nav-tab:hover{color:var(--text)}
.nav-tab.active{color:var(--coral)}
.nav-tab.active::after{content:'';position:absolute;bottom:0;left:16px;right:16px;height:2px;background:var(--coral);border-radius:1px}
.nav-tab .badge{position:absolute;top:2px;right:2px;background:var(--coral);color:#fff;font-size:10px;font-weight:700;padding:1px 5px;border-radius:10px;min-width:16px;text-align:center}
.nav-right{display:flex;align-items:center;gap:16px;font-size:13px;color:var(--text2)}
.nav-right .online{display:flex;align-items:center;gap:6px;color:#00ff88;font-weight:600;font-size:11px;text-transform:uppercase;letter-spacing:1px}
.nav-right .online .dot{width:6px;height:6px;border-radius:50%;background:#00ff88;box-shadow:0 0 8px #00ff88;animation:pulse 2s infinite}

/* STATS BAR */
.stats-bar{display:flex;gap:24px;padding:14px 24px;background:var(--bg2);border-bottom:1px solid var(--bg4);flex-wrap:wrap}
.stat-item{display:flex;align-items:center;gap:8px;font-size:13px}
.stat-item .num{font-weight:700;font-size:18px;color:var(--coral)}
.stat-item .label{color:var(--text2)}

/* SECTIONS */
.section{display:none;padding:20px 24px;min-height:calc(100vh - 120px)}
.section.active{display:block}
.section-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;flex-wrap:wrap;gap:12px}
.section-title{font-size:20px;font-weight:700}

/* FILTER TABS */
.filters{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:16px}
.filter-btn{padding:6px 14px;border-radius:20px;font-size:12px;font-weight:600;cursor:pointer;border:1px solid var(--bg4);background:var(--bg2);color:var(--text2);font-family:inherit;transition:all .2s}
.filter-btn:hover{border-color:var(--text3);color:var(--text)}
.filter-btn.active{background:var(--coral);border-color:var(--coral);color:#fff}

/* KANBAN */
.kanban{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;align-items:start}
@media(max-width:900px){.kanban{grid-template-columns:1fr 1fr}}
@media(max-width:600px){.kanban{grid-template-columns:1fr}}
.kanban-col{background:var(--bg2);border-radius:var(--radius);border:1px solid var(--bg4);min-height:200px}
.kanban-col-header{padding:14px 16px;font-size:13px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--text2);border-bottom:1px solid var(--bg4);display:flex;justify-content:space-between;align-items:center}
.kanban-col-header .count{background:var(--bg4);padding:2px 8px;border-radius:10px;font-size:11px;color:var(--text)}
.kanban-cards{padding:10px;display:flex;flex-direction:column;gap:8px;min-height:100px}
.card{background:var(--bg3);border:1px solid var(--bg4);border-radius:var(--radius-sm);padding:12px;cursor:grab;transition:all .2s}
.card:hover{border-color:var(--text3);transform:translateY(-1px)}
.card.dragging{opacity:.5}
.card-title{font-size:13px;font-weight:600;margin-bottom:6px}
.card-meta{display:flex;align-items:center;gap:6px;flex-wrap:wrap}
.agent-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.badge-pill{font-size:10px;padding:2px 8px;border-radius:10px;font-weight:600;background:var(--bg4);color:var(--text2)}
.priority-high{border-left:3px solid var(--coral)}
.priority-medium{border-left:3px solid var(--amber)}
.priority-low{border-left:3px solid var(--cyan)}

/* BUTTONS */
.btn{padding:8px 18px;border-radius:var(--radius-sm);font-size:13px;font-weight:600;cursor:pointer;border:none;font-family:inherit;transition:all .2s}
.btn-coral{background:var(--coral);color:#fff;box-shadow:0 0 15px #ff6b6b33}
.btn-coral:hover{box-shadow:0 0 25px #ff6b6b55;transform:translateY(-1px)}
.btn-green{background:#00c853;color:#fff}
.btn-green:hover{background:#00e676}
.btn-red{background:#ff4444;color:#fff}
.btn-red:hover{background:#ff6666}
.btn-ghost{background:var(--bg3);color:var(--text);border:1px solid var(--bg4)}
.btn-ghost:hover{border-color:var(--text3)}

/* MODAL */
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:200;align-items:center;justify-content:center}
.modal-overlay.open{display:flex}
.modal{background:var(--bg2);border:1px solid var(--bg4);border-radius:var(--radius);padding:24px;width:90%;max-width:500px;max-height:90vh;overflow-y:auto}
.modal h2{font-size:18px;margin-bottom:16px}
.modal label{display:block;font-size:12px;font-weight:600;color:var(--text2);margin-bottom:4px;margin-top:12px}
.modal input,.modal select,.modal textarea{width:100%;padding:10px;border-radius:var(--radius-sm);border:1px solid var(--bg4);background:var(--bg3);color:var(--text);font-family:inherit;font-size:13px}
.modal textarea{min-height:80px;resize:vertical}
.modal-actions{display:flex;gap:10px;margin-top:20px;justify-content:flex-end}

/* APPROVALS */
.approval-card{background:var(--bg2);border:1px solid var(--bg4);border-radius:var(--radius);padding:18px;margin-bottom:12px}
.approval-card.high{animation:glow-coral 3s infinite;border-color:#ff6b6b55}
.approval-card .title{font-size:15px;font-weight:700;margin-bottom:6px}
.approval-card .desc{color:var(--text2);font-size:13px;margin-bottom:12px}
.approval-card .actions{display:flex;gap:10px}
.approval-card.resolved{opacity:.5}

/* DOCS */
.docs-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:16px}
@media(max-width:900px){.docs-grid{grid-template-columns:1fr 1fr}}
@media(max-width:600px){.docs-grid{grid-template-columns:1fr}}
.doc-card{background:var(--bg2);border:1px solid var(--bg4);border-radius:var(--radius);padding:16px;cursor:pointer;transition:all .2s}
.doc-card:hover{border-color:var(--text3);transform:translateY(-2px)}
.doc-card .doc-title{font-size:14px;font-weight:700;margin-bottom:4px}
.doc-card .doc-desc{font-size:12px;color:var(--text2);margin-bottom:8px;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
.doc-card .doc-tags{display:flex;gap:4px;flex-wrap:wrap}
.doc-card .doc-tags span{font-size:10px;background:var(--bg4);padding:2px 6px;border-radius:6px;color:var(--text2)}
.doc-panel{position:fixed;top:0;right:-50%;width:50%;height:100%;background:var(--bg2);border-left:1px solid var(--bg4);z-index:150;transition:right .3s;overflow-y:auto;padding:24px}
.doc-panel.open{right:0}
.doc-panel-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
.doc-panel pre{white-space:pre-wrap;font-size:13px;font-family:'Courier New',monospace;color:var(--text);line-height:1.6;background:var(--bg3);padding:16px;border-radius:var(--radius-sm);overflow-x:auto}
@media(max-width:768px){.doc-panel{width:90%;right:-90%}.doc-panel.open{right:0}}

/* ACTIVITY */
.timeline{max-width:800px}
.timeline-item{display:flex;gap:16px;padding:14px 0;border-bottom:1px solid var(--bg4)}
.timeline-left{display:flex;flex-direction:column;align-items:center;gap:4px;min-width:80px}
.timeline-left .name{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.5px}
.timeline-right .action{font-weight:600;font-size:14px;margin-bottom:2px}
.timeline-right .details{color:var(--text2);font-size:13px}
.timeline-right .time{color:var(--text3);font-size:11px;margin-top:4px}

/* TEAM */
.team-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:20px;max-width:900px;margin:0 auto}
@media(min-width:1200px){.team-grid{grid-template-columns:repeat(4,1fr)}}
@media(max-width:600px){.team-grid{grid-template-columns:1fr}}
.team-card{background:var(--bg2);border:1px solid;border-radius:var(--radius);padding:24px;text-align:center;transition:all .3s}
.team-card:hover{transform:translateY(-4px)}
.team-card .emoji{font-size:48px;margin-bottom:12px}
.team-card .name{font-size:20px;font-weight:800;margin-bottom:4px}
.team-card .role{font-size:12px;color:var(--text2);margin-bottom:8px}
.team-card .tagline{font-size:13px;font-style:italic;color:var(--text2);margin-bottom:14px}
.team-card .specialties{display:flex;flex-wrap:wrap;gap:4px;justify-content:center;margin-bottom:14px}
.team-card .specialties span{font-size:10px;padding:3px 8px;border-radius:10px;font-weight:600}
.team-card .stats{display:flex;justify-content:center;gap:16px;font-size:11px;color:var(--text2)}
.team-card .stats strong{color:var(--text);font-weight:700}

/* Search */
.search-bar{width:100%;max-width:400px;padding:10px 16px;border-radius:var(--radius);border:1px solid var(--bg4);background:var(--bg3);color:var(--text);font-family:inherit;font-size:13px;margin-bottom:16px}
.search-bar:focus{outline:none;border-color:var(--cyan)}

/* Spinner */
.spinner{display:flex;align-items:center;justify-content:center;padding:40px;color:var(--text2);font-size:14px}
.empty{text-align:center;padding:60px 20px;color:var(--text3);font-size:14px}

/* Section stats */
.section-stats{display:flex;gap:20px;margin-bottom:16px;flex-wrap:wrap}
.section-stats .ss{font-size:13px;color:var(--text2)}
.section-stats .ss strong{color:var(--text);font-weight:700;margin-right:4px}

/* Category badges */
.cat-SOP{background:#00d4aa22;color:#00d4aa}.cat-Pipeline{background:#7c6bff22;color:#7c6bff}
.cat-Copy{background:#ff6b6b22;color:#ff6b6b}.cat-Research{background:#ffb86b22;color:#ffb86b}
.cat-Strategy{background:#00d4aa22;color:#00d4aa}.cat-Brief{background:#7c6bff22;color:#7c6bff}
.cat-Script{background:#ff6b6b22;color:#ff6b6b}
</style>
</head>
<body>

<!-- NAV -->
<nav class="nav">
  <div class="nav-left">
    <div class="nav-dot"></div>
    <h1>TOMMY HQ</h1>
  </div>
  <div class="nav-tabs" id="navTabs">
    <button class="nav-tab active" data-tab="tasks">Tasks</button>
    <button class="nav-tab" data-tab="content">Content</button>
    <button class="nav-tab" data-tab="approvals">Approvals<span class="badge" id="approvalBadge" style="display:none">0</span></button>
    <button class="nav-tab" data-tab="docs">Docs</button>
    <button class="nav-tab" data-tab="activity">Activity</button>
    <button class="nav-tab" data-tab="team">Team</button>
  </div>
  <div class="nav-right">
    <span id="clock"></span>
    <span class="online"><span class="dot"></span>SYSTEMS ONLINE</span>
  </div>
</nav>

<!-- GLOBAL STATS -->
<div class="stats-bar" id="globalStats">
  <div class="stat-item"><span class="num" id="gsOpenTasks">-</span><span class="label">Open Tasks</span></div>
  <div class="stat-item"><span class="num" id="gsPendingApprovals">-</span><span class="label">Pending Approvals</span></div>
  <div class="stat-item"><span class="num" id="gsContent">-</span><span class="label">Content in Pipeline</span></div>
  <div class="stat-item"><span class="num" id="gsDocs">-</span><span class="label">Docs</span></div>
</div>

<!-- TASKS -->
<div class="section active" id="sec-tasks">
  <div class="section-header">
    <div class="section-title">üìã Task Board</div>
    <button class="btn btn-coral" onclick="openModal('task')">+ New Task</button>
  </div>
  <div class="section-stats" id="taskStats"></div>
  <div class="filters" id="taskFilters">
    <button class="filter-btn active" data-agent="all">ALL</button>
    <button class="filter-btn" data-agent="charlie">üöÄ CHARLIE</button>
    <button class="filter-btn" data-agent="neo">üï∂Ô∏è NEO</button>
    <button class="filter-btn" data-agent="drago">ü•ä DRAGO</button>
    <button class="filter-btn" data-agent="happy">‚õ≥ HAPPY</button>
  </div>
  <div class="kanban" id="taskBoard">
    <div class="kanban-col" data-status="todo"><div class="kanban-col-header">To Do <span class="count">0</span></div><div class="kanban-cards" data-status="todo"></div></div>
    <div class="kanban-col" data-status="in-progress"><div class="kanban-col-header">In Progress <span class="count">0</span></div><div class="kanban-cards" data-status="in-progress"></div></div>
    <div class="kanban-col" data-status="review"><div class="kanban-col-header">Review <span class="count">0</span></div><div class="kanban-cards" data-status="review"></div></div>
    <div class="kanban-col" data-status="done"><div class="kanban-col-header">Done <span class="count">0</span></div><div class="kanban-cards" data-status="done"></div></div>
  </div>
</div>

<!-- CONTENT -->
<div class="section" id="sec-content">
  <div class="section-header">
    <div class="section-title">üìù Content Pipeline</div>
    <button class="btn btn-coral" onclick="openModal('content')">+ New Content</button>
  </div>
  <div class="filters" id="contentFilters">
    <button class="filter-btn active" data-agent="all">ALL</button>
    <button class="filter-btn" data-agent="charlie">üöÄ CHARLIE</button>
    <button class="filter-btn" data-agent="neo">üï∂Ô∏è NEO</button>
    <button class="filter-btn" data-agent="drago">ü•ä DRAGO</button>
    <button class="filter-btn" data-agent="happy">‚õ≥ HAPPY</button>
  </div>
  <div class="filters" id="pillarFilters">
    <button class="filter-btn active" data-pillar="all">ALL PILLARS</button>
    <button class="filter-btn" data-pillar="Dropship">Dropship</button>
    <button class="filter-btn" data-pillar="KYVO">KYVO</button>
    <button class="filter-btn" data-pillar="Golf">Golf</button>
    <button class="filter-btn" data-pillar="BBA">BBA</button>
  </div>
  <div class="kanban" id="contentBoard">
    <div class="kanban-col" data-status="Draft"><div class="kanban-col-header">Draft <span class="count">0</span></div><div class="kanban-cards" data-status="Draft"></div></div>
    <div class="kanban-col" data-status="Review"><div class="kanban-col-header">Review <span class="count">0</span></div><div class="kanban-cards" data-status="Review"></div></div>
    <div class="kanban-col" data-status="Approved"><div class="kanban-col-header">Approved <span class="count">0</span></div><div class="kanban-cards" data-status="Approved"></div></div>
    <div class="kanban-col" data-status="Posted"><div class="kanban-col-header">Posted <span class="count">0</span></div><div class="kanban-cards" data-status="Posted"></div></div>
  </div>
</div>

<!-- APPROVALS -->
<div class="section" id="sec-approvals">
  <div class="section-header">
    <div class="section-title">‚úÖ Approvals Queue</div>
    <div style="display:flex;gap:10px">
      <button class="btn btn-ghost" id="historyToggle" onclick="toggleHistory()">Show History</button>
      <button class="btn btn-coral" onclick="openModal('approval')">+ New Request</button>
    </div>
  </div>
  <div id="approvalsList"></div>
</div>

<!-- DOCS -->
<div class="section" id="sec-docs">
  <div class="section-header">
    <div class="section-title">üìö Document Library</div>
  </div>
  <input type="text" class="search-bar" placeholder="Search docs..." id="docSearch" oninput="renderDocs()">
  <div class="filters" id="docFilters">
    <button class="filter-btn active" data-cat="all">ALL</button>
    <button class="filter-btn" data-cat="SOP">SOP</button>
    <button class="filter-btn" data-cat="Copy">Copy</button>
    <button class="filter-btn" data-cat="Script">Script</button>
    <button class="filter-btn" data-cat="Research">Research</button>
    <button class="filter-btn" data-cat="Strategy">Strategy</button>
    <button class="filter-btn" data-cat="Pipeline">Pipeline</button>
    <button class="filter-btn" data-cat="Brief">Brief</button>
  </div>
  <div class="docs-grid" id="docsGrid"></div>
</div>
<div class="doc-panel" id="docPanel">
  <div class="doc-panel-header">
    <h2 id="docPanelTitle"></h2>
    <button class="btn btn-ghost" onclick="closeDocPanel()">‚úï Close</button>
  </div>
  <pre id="docPanelContent">Loading...</pre>
</div>

<!-- ACTIVITY -->
<div class="section" id="sec-activity">
  <div class="section-header">
    <div class="section-title">‚ö° Activity Feed</div>
    <span id="activityUpdated" style="font-size:12px;color:var(--text3)"></span>
  </div>
  <div class="filters" id="activityFilters">
    <button class="filter-btn active" data-agent="all">ALL</button>
    <button class="filter-btn" data-agent="charlie">üöÄ CHARLIE</button>
    <button class="filter-btn" data-agent="neo">üï∂Ô∏è NEO</button>
    <button class="filter-btn" data-agent="drago">ü•ä DRAGO</button>
    <button class="filter-btn" data-agent="happy">‚õ≥ HAPPY</button>
  </div>
  <div class="timeline" id="activityTimeline"></div>
</div>

<!-- TEAM -->
<div class="section" id="sec-team">
  <div class="section-header"><div class="section-title">üë• The Team</div></div>
  <div class="team-grid">
    <div class="team-card" style="border-color:#ff6b6b44;box-shadow:0 0 20px #ff6b6b22">
      <div class="emoji">üöÄ</div>
      <div class="name" style="color:var(--coral)">CHARLIE</div>
      <div class="role">Super Agent / Chief of Staff</div>
      <div class="tagline">"The general. Orchestrates every pillar."</div>
      <div class="specialties">
        <span style="background:#ff6b6b22;color:var(--coral)">Orchestration</span>
        <span style="background:#ff6b6b22;color:var(--coral)">Morning Brief</span>
        <span style="background:#ff6b6b22;color:var(--coral)">Memory</span>
        <span style="background:#ff6b6b22;color:var(--coral)">Strategy</span>
        <span style="background:#ff6b6b22;color:var(--coral)">Copywriting</span>
      </div>
      <div class="stats"><span><strong>47</strong> tasks</span><span><strong>12</strong> docs</span><span><strong>14</strong> days</span></div>
    </div>
    <div class="team-card" style="border-color:#00d4aa44;box-shadow:0 0 20px #00d4aa22">
      <div class="emoji">üï∂Ô∏è</div>
      <div class="name" style="color:var(--cyan)">NEO</div>
      <div class="role">Dropship Intelligence</div>
      <div class="tagline">"Sees through the matrix of ads and data."</div>
      <div class="specialties">
        <span style="background:#00d4aa22;color:var(--cyan)">Product Research</span>
        <span style="background:#00d4aa22;color:var(--cyan)">Ad Analysis</span>
        <span style="background:#00d4aa22;color:var(--cyan)">Pipeline</span>
        <span style="background:#00d4aa22;color:var(--cyan)">Gethookd</span>
        <span style="background:#00d4aa22;color:var(--cyan)">Facebook Ads</span>
      </div>
      <div class="stats"><span><strong>31</strong> tasks</span><span><strong>8</strong> docs</span><span><strong>14</strong> days</span></div>
    </div>
    <div class="team-card" style="border-color:#7c6bff44;box-shadow:0 0 20px #7c6bff22">
      <div class="emoji">ü•ä</div>
      <div class="name" style="color:var(--purple)">DRAGO</div>
      <div class="role">KYVO Performance Director</div>
      <div class="tagline">"Engineered for peak performance."</div>
      <div class="specialties">
        <span style="background:#7c6bff22;color:var(--purple)">Supplement Strategy</span>
        <span style="background:#7c6bff22;color:var(--purple)">VSL Copywriting</span>
        <span style="background:#7c6bff22;color:var(--purple)">Brand Building</span>
        <span style="background:#7c6bff22;color:var(--purple)">Email Sequences</span>
      </div>
      <div class="stats"><span><strong>18</strong> tasks</span><span><strong>6</strong> docs</span><span><strong>14</strong> days</span></div>
    </div>
    <div class="team-card" style="border-color:#ffb86b44;box-shadow:0 0 20px #ffb86b22">
      <div class="emoji">‚õ≥</div>
      <div class="name" style="color:var(--amber)">HAPPY</div>
      <div class="role">Golf & Content Coach</div>
      <div class="tagline">"Happy Gilmore energy. Serious results."</div>
      <div class="specialties">
        <span style="background:#ffb86b22;color:var(--amber)">Golf Coaching</span>
        <span style="background:#ffb86b22;color:var(--amber)">@casualgolfdad</span>
        <span style="background:#ffb86b22;color:var(--amber)">Sponsorships</span>
        <span style="background:#ffb86b22;color:var(--amber)">Swing Analysis</span>
        <span style="background:#ffb86b22;color:var(--amber)">Content Calendar</span>
      </div>
      <div class="stats"><span><strong>22</strong> tasks</span><span><strong>5</strong> docs</span><span><strong>14</strong> days</span></div>
    </div>
  </div>
</div>

<!-- MODALS -->
<div class="modal-overlay" id="modalOverlay" onclick="if(event.target===this)closeModal()">
  <div class="modal" id="modalContent"></div>
</div>

<script>
const API = '';
const API_KEY = 'thq_25741469f31452628a1d8ae7372155ef2a2bf0b7d0138d96';
const COLORS = {charlie:'var(--coral)',neo:'var(--cyan)',drago:'var(--purple)',happy:'var(--amber)'};

// State
let tasks=[],contentItems=[],approvals=[],docs=[],activities=[];
let taskFilter='all',contentAgentFilter='all',contentPillarFilter='all',docCatFilter='all',activityFilter='all';
let showHistory=false;
let activityLastFetched=null;

// Clock
function updateClock(){
  const d=new Date();
  document.getElementById('clock').textContent=d.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
}
setInterval(updateClock,1000);updateClock();

// Nav tabs
document.querySelectorAll('.nav-tab').forEach(t=>{
  t.addEventListener('click',()=>{
    document.querySelectorAll('.nav-tab').forEach(x=>x.classList.remove('active'));
    t.classList.add('active');
    document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
    document.getElementById('sec-'+t.dataset.tab).classList.add('active');
    loadSection(t.dataset.tab);
  });
});

function loadSection(tab){
  if(tab==='tasks')loadTasks();
  else if(tab==='content')loadContent();
  else if(tab==='approvals')loadApprovals();
  else if(tab==='docs')loadDocs();
  else if(tab==='activity')loadActivity();
}

// Fetch helpers
async function api(path,opts={}){
  const h={'Content-Type':'application/json'};
  if(opts.auth)h['X-API-Key']=API_KEY;
  const r=await fetch(API+path,{...opts,headers:{...h,...(opts.headers||{})}});
  return r.json();
}

// TASKS
async function loadTasks(){
  tasks=await api('/api/tasks');
  renderTasks();
  updateGlobalStats();
}
function renderTasks(){
  const filtered=taskFilter==='all'?tasks:tasks.filter(t=>t.agent===taskFilter);
  ['todo','in-progress','review','done'].forEach(s=>{
    const col=document.querySelector(`#taskBoard .kanban-cards[data-status="${s}"]`);
    const items=filtered.filter(t=>t.status===s);
    col.innerHTML=items.map(t=>`
      <div class="card priority-${t.priority||'medium'}" draggable="true" data-id="${t.id}" ondragstart="dragStart(event,'task')">
        <div class="card-title">${esc(t.title)}</div>
        <div class="card-meta">
          <span class="agent-dot" style="background:${COLORS[t.agent]||'var(--text3)'}"></span>
          <span style="font-size:11px;color:var(--text2)">${t.agent||''}</span>
          <span class="badge-pill">${t.priority||'med'}</span>
        </div>
      </div>
    `).join('')||'<div class="empty" style="padding:20px;font-size:12px">No tasks</div>';
    col.closest('.kanban-col').querySelector('.count').textContent=items.length;
  });
  // Stats
  const done=tasks.filter(t=>t.status==='done').length;
  const inP=tasks.filter(t=>t.status==='in-progress').length;
  document.getElementById('taskStats').innerHTML=`
    <div class="ss"><strong>${done}</strong>Completed</div>
    <div class="ss"><strong>${inP}</strong>In Progress</div>
    <div class="ss"><strong>${tasks.length}</strong>Total</div>
    <div class="ss"><strong>${tasks.length?Math.round(done/tasks.length*100):0}%</strong>Completion</div>
  `;
}

// Filter clicks (tasks)
document.getElementById('taskFilters').addEventListener('click',e=>{
  if(!e.target.classList.contains('filter-btn'))return;
  document.querySelectorAll('#taskFilters .filter-btn').forEach(b=>b.classList.remove('active'));
  e.target.classList.add('active');
  taskFilter=e.target.dataset.agent;
  renderTasks();
});

// Drag & drop (tasks)
let dragId=null,dragType=null;
function dragStart(e,type){dragId=e.target.dataset.id;dragType=type;e.target.classList.add('dragging')}
document.querySelectorAll('#taskBoard .kanban-cards').forEach(col=>{
  col.addEventListener('dragover',e=>{e.preventDefault()});
  col.addEventListener('drop',async e=>{
    e.preventDefault();
    if(dragType!=='task'||!dragId)return;
    document.querySelectorAll('.dragging').forEach(x=>x.classList.remove('dragging'));
    const newStatus=col.dataset.status;
    await api('/api/tasks',{method:'PUT',auth:true,body:JSON.stringify({id:dragId,status:newStatus})});
    dragId=null;
    loadTasks();
  });
});

// CONTENT
async function loadContent(){
  contentItems=await api('/api/content');
  renderContent();
  updateGlobalStats();
}
function renderContent(){
  let filtered=contentItems;
  if(contentAgentFilter!=='all')filtered=filtered.filter(c=>c.agent===contentAgentFilter);
  if(contentPillarFilter!=='all')filtered=filtered.filter(c=>c.pillar===contentPillarFilter);
  ['Draft','Review','Approved','Posted'].forEach(s=>{
    const col=document.querySelector(`#contentBoard .kanban-cards[data-status="${s}"]`);
    const items=filtered.filter(c=>c.status===s);
    col.innerHTML=items.map(c=>`
      <div class="card" draggable="true" data-id="${c.id}" ondragstart="dragStart(event,'content')">
        <div class="card-title">${esc(c.title)}</div>
        <div class="card-meta">
          <span class="agent-dot" style="background:${COLORS[c.agent]||'var(--text3)'}"></span>
          <span class="badge-pill">${esc(c.platform||'')}</span>
          <span class="badge-pill">${esc(c.pillar||'')}</span>
        </div>
      </div>
    `).join('')||'<div class="empty" style="padding:20px;font-size:12px">No content</div>';
    col.closest('.kanban-col').querySelector('.count').textContent=items.length;
  });
}
document.getElementById('contentFilters').addEventListener('click',e=>{
  if(!e.target.classList.contains('filter-btn'))return;
  document.querySelectorAll('#contentFilters .filter-btn').forEach(b=>b.classList.remove('active'));
  e.target.classList.add('active');
  contentAgentFilter=e.target.dataset.agent;
  renderContent();
});
document.getElementById('pillarFilters').addEventListener('click',e=>{
  if(!e.target.classList.contains('filter-btn'))return;
  document.querySelectorAll('#pillarFilters .filter-btn').forEach(b=>b.classList.remove('active'));
  e.target.classList.add('active');
  contentPillarFilter=e.target.dataset.pillar;
  renderContent();
});
document.querySelectorAll('#contentBoard .kanban-cards').forEach(col=>{
  col.addEventListener('dragover',e=>{e.preventDefault()});
  col.addEventListener('drop',async e=>{
    e.preventDefault();
    if(dragType!=='content'||!dragId)return;
    document.querySelectorAll('.dragging').forEach(x=>x.classList.remove('dragging'));
    await api('/api/content',{method:'PUT',auth:true,body:JSON.stringify({id:dragId,status:col.dataset.status})});
    dragId=null;
    loadContent();
  });
});

// APPROVALS
async function loadApprovals(){
  approvals=await api('/api/approvals');
  renderApprovals();
  updateGlobalStats();
}
function renderApprovals(){
  const pending=approvals.filter(a=>a.status==='pending').sort((a,b)=>{const p={high:0,medium:1,low:2};return(p[a.priority]||1)-(p[b.priority]||1)});
  const resolved=approvals.filter(a=>a.status!=='pending');
  let html=pending.map(a=>`
    <div class="approval-card ${a.priority==='high'?'high':''}">
      <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:8px">
        <div>
          <div class="title">${esc(a.title)}</div>
          <div class="card-meta" style="margin-top:4px">
            <span class="agent-dot" style="background:${COLORS[a.agent]}"></span>
            <span style="font-size:12px;color:var(--text2)">${a.agent}</span>
            <span class="badge-pill">${esc(a.type||'Action')}</span>
            <span class="badge-pill">${a.priority}</span>
          </div>
        </div>
        <span style="font-size:11px;color:var(--text3)">${timeAgo(a.created_at)}</span>
      </div>
      <div class="desc">${esc(a.description||'')}</div>
      <div class="actions">
        <button class="btn btn-green" onclick="resolveApproval('${a.id}','approved')">‚úì APPROVE</button>
        <button class="btn btn-red" onclick="resolveApproval('${a.id}','rejected')">‚úó REJECT</button>
      </div>
    </div>
  `).join('');
  if(!pending.length)html='<div class="empty">No pending approvals üéâ</div>';
  if(showHistory&&resolved.length){
    html+=`<h3 style="margin:24px 0 12px;color:var(--text2)">History</h3>`;
    html+=resolved.map(a=>`
      <div class="approval-card resolved">
        <div class="title">${esc(a.title)} <span class="badge-pill">${a.status}</span></div>
        <div class="card-meta" style="margin-top:4px"><span class="agent-dot" style="background:${COLORS[a.agent]}"></span><span style="font-size:12px;color:var(--text2)">${a.agent}</span></div>
      </div>
    `).join('');
  }
  document.getElementById('approvalsList').innerHTML=html;
  // Badge
  const badge=document.getElementById('approvalBadge');
  if(pending.length){badge.textContent=pending.length;badge.style.display='inline'}else{badge.style.display='none'}
}
async function resolveApproval(id,status){
  await api('/api/approvals',{method:'PUT',auth:true,body:JSON.stringify({id,status})});
  loadApprovals();
}
function toggleHistory(){
  showHistory=!showHistory;
  document.getElementById('historyToggle').textContent=showHistory?'Hide History':'Show History';
  renderApprovals();
}

// DOCS
async function loadDocs(){
  docs=await api('/api/docs');
  renderDocs();
  updateGlobalStats();
}
function renderDocs(){
  const q=(document.getElementById('docSearch').value||'').toLowerCase();
  let filtered=docs;
  if(docCatFilter!=='all')filtered=filtered.filter(d=>d.category===docCatFilter);
  if(q)filtered=filtered.filter(d=>(d.title+' '+d.description+' '+(d.tags||[]).join(' ')).toLowerCase().includes(q));
  document.getElementById('docsGrid').innerHTML=filtered.map(d=>`
    <div class="doc-card" onclick="openDoc('${esc(d.file_path)}','${esc(d.title)}')">
      <div class="card-meta" style="margin-bottom:8px">
        <span class="agent-dot" style="background:${COLORS[d.agent]}"></span>
        <span class="badge-pill cat-${d.category}">${d.category}</span>
      </div>
      <div class="doc-title">${esc(d.title)}</div>
      <div class="doc-desc">${esc(d.description||'')}</div>
      <div class="doc-tags">${(d.tags||[]).map(t=>'<span>'+esc(t)+'</span>').join('')}</div>
    </div>
  `).join('')||'<div class="empty">No docs found</div>';
}
document.getElementById('docFilters').addEventListener('click',e=>{
  if(!e.target.classList.contains('filter-btn'))return;
  document.querySelectorAll('#docFilters .filter-btn').forEach(b=>b.classList.remove('active'));
  e.target.classList.add('active');
  docCatFilter=e.target.dataset.cat;
  renderDocs();
});
async function openDoc(path,title){
  document.getElementById('docPanel').classList.add('open');
  document.getElementById('docPanelTitle').textContent=title;
  document.getElementById('docPanelContent').textContent='Loading...';
  try{
    const r=await api('/api/docs?path='+encodeURIComponent(path));
    document.getElementById('docPanelContent').textContent=r.content||'(empty)';
  }catch{document.getElementById('docPanelContent').textContent='Failed to load file'}
}
function closeDocPanel(){document.getElementById('docPanel').classList.remove('open')}

// ACTIVITY
async function loadActivity(){
  activities=await api('/api/activity');
  activityLastFetched=new Date();
  renderActivity();
}
function renderActivity(){
  const filtered=activityFilter==='all'?activities:activities.filter(a=>a.agent===activityFilter);
  document.getElementById('activityTimeline').innerHTML=filtered.map(a=>`
    <div class="timeline-item">
      <div class="timeline-left">
        <span class="agent-dot" style="background:${COLORS[a.agent]};width:12px;height:12px"></span>
        <span class="name" style="color:${COLORS[a.agent]}">${a.agent}</span>
      </div>
      <div class="timeline-right">
        <div class="action">${esc(a.action)}</div>
        <div class="details">${esc(a.details||'')}</div>
        <div class="time">${timeAgo(a.timestamp)}</div>
      </div>
    </div>
  `).join('')||'<div class="empty">No activity yet</div>';
  if(activityLastFetched){
    const sec=Math.round((Date.now()-activityLastFetched)/1000);
    document.getElementById('activityUpdated').textContent=`Last updated: ${sec}s ago`;
  }
}
document.getElementById('activityFilters').addEventListener('click',e=>{
  if(!e.target.classList.contains('filter-btn'))return;
  document.querySelectorAll('#activityFilters .filter-btn').forEach(b=>b.classList.remove('active'));
  e.target.classList.add('active');
  activityFilter=e.target.dataset.agent;
  renderActivity();
});
// Auto-refresh activity
setInterval(()=>{
  if(document.getElementById('sec-activity').classList.contains('active'))loadActivity();
  if(activityLastFetched){
    const sec=Math.round((Date.now()-activityLastFetched)/1000);
    document.getElementById('activityUpdated').textContent=`Last updated: ${sec}s ago`;
  }
},30000);

// GLOBAL STATS
function updateGlobalStats(){
  document.getElementById('gsOpenTasks').textContent=tasks.filter(t=>t.status!=='done').length;
  document.getElementById('gsPendingApprovals').textContent=approvals.filter(a=>a.status==='pending').length;
  document.getElementById('gsContent').textContent=contentItems.filter(c=>c.status!=='Posted').length;
  document.getElementById('gsDocs').textContent=docs.length;
}

// MODALS
function openModal(type){
  const m=document.getElementById('modalContent');
  if(type==='task'){
    m.innerHTML=`<h2>New Task</h2>
      <label>Title</label><input id="mTitle">
      <label>Agent</label><select id="mAgent"><option>charlie</option><option>neo</option><option>drago</option><option>happy</option></select>
      <label>Priority</label><select id="mPriority"><option>medium</option><option>high</option><option>low</option></select>
      <label>Status</label><select id="mStatus"><option value="todo">To Do</option><option value="in-progress">In Progress</option><option value="review">Review</option><option value="done">Done</option></select>
      <div class="modal-actions"><button class="btn btn-ghost" onclick="closeModal()">Cancel</button><button class="btn btn-coral" onclick="submitTask()">Create</button></div>`;
  }else if(type==='content'){
    m.innerHTML=`<h2>New Content</h2>
      <label>Title</label><input id="mTitle">
      <label>Agent</label><select id="mAgent"><option>charlie</option><option>neo</option><option>drago</option><option>happy</option></select>
      <label>Pillar</label><select id="mPillar"><option>Dropship</option><option>KYVO</option><option>Golf</option><option>BBA</option></select>
      <label>Platform</label><select id="mPlatform"><option>Instagram</option><option>TikTok</option><option>YouTube</option><option>Email</option><option>Facebook Ad</option><option>Blog</option></select>
      <label>Status</label><select id="mContentStatus"><option>Draft</option><option>Review</option><option>Approved</option><option>Posted</option></select>
      <label>Notes</label><textarea id="mNotes"></textarea>
      <div class="modal-actions"><button class="btn btn-ghost" onclick="closeModal()">Cancel</button><button class="btn btn-coral" onclick="submitContent()">Create</button></div>`;
  }else if(type==='approval'){
    m.innerHTML=`<h2>New Approval Request</h2>
      <label>Title</label><input id="mTitle">
      <label>Description</label><textarea id="mDesc"></textarea>
      <label>Agent</label><select id="mAgent"><option>charlie</option><option>neo</option><option>drago</option><option>happy</option></select>
      <label>Type</label><select id="mType"><option>Content</option><option>Ad Spend</option><option>Action</option><option>Campaign</option></select>
      <label>Priority</label><select id="mPriority"><option>medium</option><option>high</option><option>low</option></select>
      <div class="modal-actions"><button class="btn btn-ghost" onclick="closeModal()">Cancel</button><button class="btn btn-coral" onclick="submitApproval()">Submit</button></div>`;
  }
  document.getElementById('modalOverlay').classList.add('open');
}
function closeModal(){document.getElementById('modalOverlay').classList.remove('open')}

async function submitTask(){
  await api('/api/tasks',{method:'POST',auth:true,body:JSON.stringify({
    title:document.getElementById('mTitle').value,
    agent:document.getElementById('mAgent').value,
    priority:document.getElementById('mPriority').value,
    status:document.getElementById('mStatus').value
  })});
  closeModal();loadTasks();
}
async function submitContent(){
  await api('/api/content',{method:'POST',auth:true,body:JSON.stringify({
    title:document.getElementById('mTitle').value,
    agent:document.getElementById('mAgent').value,
    pillar:document.getElementById('mPillar').value,
    platform:document.getElementById('mPlatform').value,
    status:document.getElementById('mContentStatus').value,
    notes:document.getElementById('mNotes').value
  })});
  closeModal();loadContent();
}
async function submitApproval(){
  await api('/api/approvals',{method:'POST',auth:true,body:JSON.stringify({
    title:document.getElementById('mTitle').value,
    description:document.getElementById('mDesc').value,
    agent:document.getElementById('mAgent').value,
    type:document.getElementById('mType').value,
    priority:document.getElementById('mPriority').value
  })});
  closeModal();loadApprovals();
}

// Helpers
function esc(s){if(!s)return'';const d=document.createElement('div');d.textContent=s;return d.innerHTML}
function timeAgo(ts){
  if(!ts)return'';
  const s=Math.floor((Date.now()-new Date(ts))/1000);
  if(s<60)return s+'s ago';
  if(s<3600)return Math.floor(s/60)+'m ago';
  if(s<86400)return Math.floor(s/3600)+'h ago';
  return Math.floor(s/86400)+'d ago';
}

// Init ‚Äî load all data
(async()=>{
  await Promise.all([loadTasks(),loadContent(),loadApprovals(),loadDocs(),loadActivity()]);
})();

// Auto-refresh tasks every 30s
setInterval(()=>{
  if(document.getElementById('sec-tasks').classList.contains('active'))loadTasks();
},30000);
</script>
</body>
</html>
